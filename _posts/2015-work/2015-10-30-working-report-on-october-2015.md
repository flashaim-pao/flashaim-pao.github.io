---
layout: post
title: '工作紀實 2015年 10月'
date: 2015-10-30 14:42
image: ''
description: ''
categories:
    - 工作紀實
tags:
    - 月報
    - 知識科技
 
---
# α 產品

本月因為帳務的架構修改，大都在補強與修正，這個*儲值扣款機制*實在讓我傷透腦筋。但有了這個經驗，也能推廣到將來**客戶統一入口**的儲值扣款功能。另一方面，這個月 Tina 仍陸續增加畫面。除了修改與修正以外，還增加了*社群網路*的頁面。這項功能的技術核心同樣使用了*競爭者分析系統*，複製先前的開發經驗延伸至其他網站，應該是相對容易且問題較小的。因此臨時請信宇暫時調派過來支援，由信宇與冠宇協同開發*社群網路*的*網路爬蟲*，如此一來應該可以加快不少進度。然而我得先製作一組網路爬蟲作為範例，而且信宇也要花時間搭建開發環境。萬事起頭難，希望這裡可以順利才好。而為了能抓緊時間，我也向老師請假*暫時恢復每週工作五天*，盡可能加快腳步以免讓客戶繼續等待。

α 產品在技術使用上是相對較大膽的，用了**早期版本**的 Typescript, Angular.js 甚至是 Angular Material 等。雖然可以得到更先進友善的介面、更佳的系統反應以及維護性等；因此相對容易遇到程式庫 bug 或功能不足時需要**跟進新版本**，也就常撞到 *breaking changes*。像這幾次的升級就撞到了幾個（暈），讓我們每次升級搞得很緊張。不過隨著程式庫版本越來越穩定，或許之後就不必太擔心了吧（革命先烈？）。

在 α 產品的開發歷程裡引入了所謂的*資料庫遷移（Database Migration)*，是一套規範**資料庫改變流程**的機制與程式。原本以為這樣就會一帆風順，殊不知團隊所使用的*版本控管流程*，會使得資料庫遷移的順序被打亂，發生過兩次狀況。也因此針對資料庫遷移，對開發流程做了兩次更動。也幸好我所堅持的 *build, test, peer review, deploy 流程*，使得問題還沒到正式機就浮現了。縱使這些作為會提高人力成本，但輕忽品質的後果終究會在某時某處爆發的。

## Review 的項目

* #157: 修正官網交易明細欄位編排
* #164: 使用者操作加入到點數紀錄
* #184: 更換四大平台的 social icon
* #186: create useroptions
* #191: 修正新增使用者與修改使用者
* #194: 實作立即改善 mashup 畫面 step 1 - 顯示所有活動連結網址
* #195: 實作立即改善 mashup 畫面 step 2 - 改善內容
* #197: Users 資料表 Balance 拿掉後台使用者需調整
* #198: Users 資料表 Balance 拿掉後官網使用者資料需調整

## Review 並接續修改的項目

* #185: 實作競爭者分析 social 列表及內頁
* #193: 更新立即改善彈跳畫面

## 完成的項目

* #150: 使用者餘額不足時禁止新增帳戶分析的連結
    + 阻擋於 RESTful API
    + 阻擋於前端
    + 花費超過時顯示提示
    + 修正扣款邏輯
* #172: 升級 Angular Material 至 1.0.0-RC1
* #188: 廣告活動離線分佈圖表
* #189: 拿掉資料表 Users 的 Balance 欄位改用即時計算
* #190: migration V35
* #192: 競爭者分析無法顯示詳細內容
* #196: 升級 Angular.js 至 1.4.7
* #199: 沒有儲值記錄的使用者登入前台將會出錯
* #202: 實作競爭者分析的相關詞分析功能

# MS 產品

本月仍舊經常地從*各方面*協助 MS 產品，然而 MS 產品遭遇到的效能問題在本月也*越趨嚴重*，我也就花了更多時間協助 MS 產品找問題與修正。

* 協助修正伺服器無法辨識 SVG 圖片的問題
    + 原因：伺服器告訴瀏覽器圖檔的型態是錯誤的（`text/xml`） <= 應該是 `image/svg+xml`
    + 修正
        - `/etc/mime.types` => `image/svg+xml   		 svg svgz`
        - `/etc/httpd/conf/httpd.conf` => `AddType image/svg+xml svg svgz`
    + 參考文獻 >> http://goo.gl/pudnwq
* 協助設定 domain >> **共 7 個**
* 協助信宇設定 MS 產品 **測試伺服器**以及**本機電腦**
* 同仁哥至中華電信討論雲端主機相關問題

## 協助分析 MS 產品 效能瓶頸

首先我與仁哥從中華電信 *HiCloud CaaS* 的*後台效能監視器*著手觀察（我已於先前當機事件時，安裝好效能監視器），然而觀察到處理器與記憶體的使用率都不高，而且*磁碟使用率*幾乎沒有變化所以不具指標性，也因此往主機 I/O 瓶頸的方向去分析。

* 協助分析 MS 產品 的 Apache access log （僅9月中至10/19）
    + 使用 `awk/uniq` 等指令處理 log
        - 最高每秒請求 311 次
        - 請求數量沒有維持在高峰  << 因此無法判斷是否為伺服器總負載不足
* 協助調查 I/O 是否有瓶頸
    + 使用 `iostat` 持續蒐集 MS 產品 的 I/O 狀態
    		- 10/20 上午 至 中午
    + 使用指令解析 log 並使用 `gnuplot` 繪製圖表
		    - http://i.imgur.com/XQWnH9a.png
    + 分析結果
        - I/O 利用率有許多突波呈現滿載
        - CPU I/O waiting 時間也經常呈現高峰 ( > 3%)

## MS 產品 資料庫分流計畫

種種跡象顯示 I/O 是瓶頸所在，然而是**甚麼造成的**也還是難以得到結論。所以，我們只好每種方法都去嘗試，例如安軒朝著*檔案瘦身*的方向，而我則是協助將 MS 產品資料庫切出去為獨立的主機，將部分的 I/O 分流出去。一開始我先做 dry-run 測試，將整個過程演練過一次。而大夥則約在週日深夜開始動工，過程還蠻順利的。但是測試花了很多時間，讓我們都睡眠不足。

* 設定 MS-DB 主機上的 MySQL
    + 帳號、密碼與資料庫
    + 限制僅允許 MS 產品正式機的連線
* 測試 MS 產品正式機資料的匯入
    + 匯出約 3~4 分鐘
    + 匯入約 3~4 分鐘
    + 空間佔約 2.5 GB
* 從 MS 產品**匯出資料庫並匯入** MS-DB 的資料庫
* 建立**帳號**與設定 **phpMyAdmin**
* 根據現況修改 MS 產品資料庫**備份腳本**

## MS 產品主機硬體升級計畫

資料庫獨立出去後，效果非常有限。當然，我們也希望每一種方法都試過以後，能夠得到**綜效**！後來我陪同仁哥到中華電信直接與對方工程師討論，看有什麼解決方案。才隔一天，中華電信回覆裡提到，將主機改為「超高運算量」等級，其 IOPS 的能力較原來的高許多。因此我們也開始了主機升級的計畫，同樣也是個深夜（打瞌睡）。其實過程也還算順利的，沒有影響到主機的組態。不過開機後，因為 CentOS 自動進行磁碟檢查而停留很久，讓我們虛驚一場。最後進行測試時發現，傳輸速度有快了一些。然而還是有一些網站一樣卡在**第一次回應時間**（TTFB），更詭異的是這時間點應該幾乎是無負載的狀況，不太可能還是主機硬體 I/O 能力不足。所以最後的猜測是，*程式架構*有可能是造成 I/O 瓶頸的關鍵。但觀察程式的效能瓶頸在哪就是個困難，架構的修改就更加有難度了，這方面可得從長計議。

# 其他

* 協助小佩 α 產品技術方面的相關資料
* 協助阿信自動定時修改 FTP 寫入權限
    + 問題 >> 2015/10/3 9:00 準時關閉 FTP 上傳權限
    + 解決 >> 使用 Linux 內建指令
        - at << 單次排程指令
        - chmod << 檔案/目錄權限修改
* 協助撰寫 FAQ >> NADS, α 產品
* 調查 Yahoo Gemini API 的報表是否含有品質分數
* 協助申請與設定 Github 服務
* 協助建立 R&D 知識分享中心 >> https://github.com/flashaim/whitebook
        
