---
layout: post
title: '工作紀實 2017年 7月'
date: 2017-07-30 16:00
comments: true
categories: 
---
# FSB 產品

本月延續上個月，主要在 FSB 產品的一對一對話功能的開發工作。首先是一個新的需求。原先消費者進入一對一對話模式時，管理員會從 APP 收到一則通知。在消費者*還沒取消一對一對話模式*之前，*停留了一段很長的時間後*再次發訊息。此時，管理者便不會再次於 APP 收到訊息。所以合併了原來的通知程式，增加了新的通知條件，讓管理員於 APP 可以再次收到通知。

第二項新需求是增加**傳送圖片訊息**的功能，已經開發完成待 review 與佈署。最後則是一對一對話效能的優化。最初一對一對話是鎖定百人左右的效能，當然*時間跟人力無限*的話，我們可以開發**萬人**的版本呀，哈。只是上線後發現，客戶會員還真多呀！馬上就撞到效能之牆了。

這邊要先提的是，一對一對話操作系統是採用 **Web App** 設計，只要有瀏覽器就能擁有如 App 般的操作體驗。前提是要改為**寫 Front-end code（前端程式）**，而前端程式是**在瀏覽器身上執行**的（非工程師很難體會這段話背後的含意）。很可惜，瀏覽器的效能非常差，即使 Chrome 讓效能提昇了百倍，但是跟原生程式（例如 App）比起來，還是差了[數十倍](https://goo.gl/LCMpky)（所以古時候瀏覽器的效能之爛呀...）。在聖杯 WebAssembly 實現之前（有生之年？），***環境怎麼樣，我們就怎麼做吧！***

分析效能瓶頸後發現，主要有兩者：第一個是聊天室 DOM Node (Document Object Model) 太多，繪製工作較吃重；第二是每組 DOM 都有一張圖，以致於瀏覽器同時下載太多張圖。所以改為 **Load-on-demand** 方式去組聊天室 DOM，有出現在畫面的才即時繪製。也就一併減少了同時下載的圖片數量，整體效能便提昇了許多。此外，也將 AJAX 傳輸資料加上 gzip 壓縮，減少了數倍至數十倍的傳輸量。優化至此，已滿足當下需求，先暫時告一段落。畢竟 BC 平台可以提供更充足的後端運算資源，一次將當下的 FSB 優化到頂不太實際。

* #598 改善一對一聊天的效能
    + 使用 gzip 壓縮通訊資料
    + 聊天室清單改 Load-on-demand
* #599 一對一聊天後台提供圖片訊息功能
* #612 一對一太久沒有對話管理者端的再次推撥提醒

# BC 平台

為了因應不久的將來，使用者人數急劇上升的狀況，規劃與設計了此 BC 平台。原本是要立基於 Matrix 平台之上的。由於產品推出的優先性，便在沒有 Matrix 的情況下，先獨立發展。BC 平台最主要的目標就是**承載力**，因此系統設計會環繞在**叢集架構**上。本月已設計出*後端系統架構*以及有**特殊能力**的 *Chatbot 程式架構*。由於團隊包含我在內，手頭上皆有急迫的工作得優先處理。但下個月將優先工作告一段落後，將會是以 BC 平台開發為主。

* 後端系統架構設計
* Chatbot 程式架構設計
    + https://goo.gl/PWjTfA

# EB 專案

本月緊急的工作項目包含了這專案，是幫 N 社製作一個系統。由於團隊都在趕工手邊急迫的工作，所以此專案由我一人專責開發。專案雖然不大但也不小，加上預留的時間太少，中間還有更緊迫的工作插進來要優先處理，以致於後台還未完工。希望接下來這幾天內能趕完才好（苦笑）...

# FMM 專案

支援了此專案，調查網站變慢與登入異常的狀況。發現首頁圖片沒有正確啟用快取，因為圖片是採用 PHP 程式餵給瀏覽器，漏了 HTTP 快取的設定。如果是透過網頁伺服器（Nginx）餵圖片，預設是啟用 HTTP 快取的。首頁的圖片特別多，加上 PHP 先天的特性（有著程式同時執行的上限，一般很難達到），每個人進入首頁都會下載大量圖片，使得 PHP 忙於餵圖片而無法讓後台正常登入（因為塞車囉）。分析出瓶頸後，接下來就交給團隊來解決囉～

* 協助調查網站變慢及登入異常原因
    + 圖片沒有正確啟用快取

# 其他

* 調查與清理 S1 空間（不足）
    + 某個客戶網站的 error log 太大（三個）
* 修正 SSL 自動更新 scripts 的錯誤
* 協助團隊建立測試機的 HTTPs 反向通道至各自的本機上
    + 以便於在本機除錯 chat bot
		+ API 要求一定要「SSL/HTTPs」才能使用
		    - 本機是沒有 Domain 也沒有 SSL 的
* 研究 Messenger 啟用 Chat API 是否會失去對話功能

# 後記

除了加班趕工以外，還有忙博士研究以及幫忙一些事情。導致一整週都沒睡到多久，全身上下到處都在痛，也一直頭痛。連續吃好幾天的止痛藥還有貼布。看來年紀到了，沒辦法跟年輕小伙子一樣，身體還是要顧好才是（苦笑 again）。
